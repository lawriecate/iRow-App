<!DOCTYPE html> 
<html> 
	<head> 
	<title>iRow Athlete App</title> 
	
	<meta name="viewport" content="width=device-width, initial-scale=1"> 

	<link rel="stylesheet" href="jquery.mobile-1.4.1.min.css" />
	<script src="jquery-1.7.1.min.js"></script>
	<script src="jquery.mobile-1.4.1.min.js"></script>
	<style type="text/css">
	#splash {
		background-image: url('splash.jpg');
		background-size: cover;
    background-repeat: no-repeat;
	}
#splash h1 {
		font-size: 7em;
		margin: 0;
}
	#splash h1,h2,h3 {
		color: #fff;
		 text-shadow: 1px 0px 20px #000;
		 text-stroke:1px #000 ;
		text-align: center;
	}

	#splash p,.protomsg {
		background: rgba(0,0,0,0.5);
		padding: 4px;
		border-radius: 4px;
		text-shadow:none;
		color: #fff;
	}
	</style>
</head> 

<body> 
<!-- Start of first page -->
<div data-role="page" id="splash">

	<!--<div data-role="header">
		<h1>Welcome</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h1>iRow</h1>
		<h3>Prototype</h3>
		<h2>Welcome</h2>
		<p>This is the iRow prototype app, for testing purposes only.</p>		
			
		<p><a href="#login" data-transition="slideup">Click here to start</a></p>	
		<p><a href="http://beta.irow.co.uk/">iRow online</a></p>
	</div><!-- /content -->

	<!--<div data-role="footer">
		<h4>LGC</h4>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of login page -->
<div data-role="page" id="login">

	<div data-role="header">
		<h1>Login</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<form id="loginForm" action="http://beta.irow.co.uk/login/?format=json" method="post">

			<div data-role="fieldcontain">
	         <label for="email">Email:</label>
	         <input type="email" name="email" id="loginEmail" value=""  />
			</div>

			<div data-role="fieldcontain">
	         <label for="password">Password:</label>
	         <input type="password" name="password" id="loginPassword" value=""  />
			</div>
			
			<div class="ui-body ">
					<div class=""><button type="submit" data-theme="a">Sign In</button></div>
			</div>
	</form>
		<p>View internal page called <a href="#logbook" data-transition="pop">logbook</a></p>		
		<p>View internal page called <a href="#add" data-transition="slide">register</a></p>	
	</div><!-- /content -->

	<!--<div data-role="footer">
		<h4>LGC</h4>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of sign up page -->
<div data-role="page" id="register">

	<div data-role="header">
		<h1>Sign Up</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<p>Register Form Goes Here.  For now please register on at <a href="http://beta.irow.co.uk/register" target="_blank">beta.irow.co.uk/register</a></p>	
		<p>View internal page called <a href="#logbook" data-transition="pop">logbook</a></p>		
	</div><!-- /content -->

	<div data-role="footer" >
		<h4></h4>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of logbook page -->
<div data-role="page" id="logbook">

	<div data-role="header"  data-position="fixed">
		<h1>Logbook</h1>
		<a href="#" data-icon="refresh" class="ui-btn-right" id="btnSync">Sync</a>
	</div><!-- /header -->

	<div data-role="content">	
		<ul id="logbookList" data-role="listview" data-theme="d" data-divider-theme="d">
		
		</ul>
		<!--<p>View internal page called <a href="#add" data-transition="slideup">ADD Activity</a></p>		
		<p>View internal page called <a href="#settings" data-transition="flip">settings</a></p>-->	
	</div><!-- /content -->

	<div data-role="footer" class="ui-bar" data-position="fixed">
		<a href="#add" data-role="button" data-icon="plus" data-transition="slideup">Add</a>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of view page -->
<div data-role="page" id="activity">

	<div data-role="header">
		<a href="#logbook" data-transition="slide" data-icon="arrow-l">Done</a>
		<h1>View</h1>
		
	</div><!-- /header -->

	<div data-role="content">	
		<h1 id="viewLabel"></h1>
		<p>Split: <span id="viewSplit">&nbsp;</span></p>
		<p>Time: <span id="viewTime">&nbsp;</span></p>
		<p>Distance: <span id="viewDistance">&nbsp;</span></p>
		<p>Rate: <span id="viewRate">&nbsp;</span></p>
		<p>HR: <span id="viewHr">&nbsp;</span></p>

		<!--<p>View internal page called <a href="#add" data-transition="slideup">ADD Activity</a></p>		
		<p>View internal page called <a href="#settings" data-transition="flip">settings</a></p>-->	
	</div><!-- /content -->


</div><!-- /page -->

<!-- Start of log page -->
<div data-role="page" id="add">

	<div data-role="header" data-position="fixed">
		<h1>Log Activity</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<form action="#" method="get">
			<!--<div data-role="fieldcontain">
			    <fieldset data-role="controlgroup" >
			     	<legend>Type:</legend>
			         	<input type="radio" name="type" id="radio-choice-a" value="1" checked="checked" />
			         	<label for="radio-choice-a">Erg</label>
			         	<input type="radio" name="type" id="radio-choice-b" value="2" />
			         	<label for="radio-choice-b">Water</label>
			         	<input type="radio" name="type" id="radio-choice-c" value="3" />
			         	<label for="radio-choice-c">Indoor</label>
			         	<input type="radio" name="type" id="radio-choice-d" value="4" />
			         	<label for="radio-choice-d">Outdoor</label>
			    </fieldset>

			</div>
			<div data-role="fieldcontain">
			    <fieldset data-role="controlgroup" data-type="horizontal">
			     	<legend>Type:</legend>
			         	<input type="radio" name="radio-choice-b" id="radio-choice-c" value="on" checked="checked" />
			         	<label for="radio-choice-c">Timed</label>
			         	<input type="radio" name="radio-choice-b" id="radio-choice-d" value="off" />
			         	<label for="radio-choice-d">Distance</label>

			    </fieldset>

			</div>-->
			<div class="fieldcontain">
				<label for="inputType" class="select">Type:</label>
				<select name="inputType" id="inputType">
				   
				</select>
				</div>


			<div data-role="fieldcontain">
	         <label for="name">When:</label>
	         <input type="date" name="inputWhen" id="inputWhen" value=""  />
			</div>

			<div data-role="fieldcontain">
	         <label for="name">Time:</label>
	         <div class="ui-grid-b">
	         	<div  class="ui-block-a">
		         <input type="number" name="inputTime1" id="inputTime1" value="" min="0" max="60" placeholder="00"  />
		     </div>
		     <div class="ui-block-b"  style="width:4%">
		        <p> :</p>
		        </div>
		        <div class="ui-block-c" >
		         <input type="number" name="inputTime2" id="inputTime2" value="" min="0" max="60" placeholder="00.0" step="0.1"  />
		     </div>
		     </div>
			</div>

			<div data-role="fieldcontain">
				<div class="ui-grid-b">

		         <label for="inputDistance">Distance:</label>
		         	<div  class="ui-block-a">
			        	 <input type="number" name="inputDistance" id="inputDistance" value="" min="0" max="1000000" placeholder="0000"/>
			   		</div>
			   	</div>
			</div>


			<div data-role="fieldcontain">
	         <label for="name">Split:</label>
	         <div class="ui-grid-b">
	         	<div  class="ui-block-a">
		         <input type="number" name="inputSplit1" id="inputSplit1" value="" min="0" max="60" placeholder="0"  />
		     </div>
		     <div class="ui-block-b" style="width:4%">
		        <p>:</p>
		        </div>
		        <div class="ui-block-c" >
		         <input type="number" name="inputSplit2" id="inputSplit2" value="" min="0" max="60" placeholder="00.0" step="0.1" />
		     </div>
		     </div>
			</div>

			<div data-role="fieldcontain">
				<div class="ui-grid-b">

		         <label for="inputRate">Rate:</label>
		         	<div  class="ui-block-a">
			        	 <input type="number" name="inputRate" id="inputRate" value="" min="0" max="90" placeholder="00"/>
			   		</div>
			   	</div>
			</div>

			<div data-role="fieldcontain">
			<label for="textarea">Notes:</label>
			<textarea cols="40" rows="8" name="inputNotes" id="inputNotes"></textarea>
			</div>

			


		<!--<div class="ui-body ui-body-b">
		<fieldset class="ui-grid-a">
				<div class="ui-block-a"><button type="submit" data-theme="d">Cancel</button></div>
				<div class="ui-block-b"><button type="submit" data-theme="a">Submit</button></div>
	    </fieldset>
		</div>-->
	</form>
		<!--<p>View internal page called <a href="#logbook" data-transition="slidedown">logbook</a></p>		-->
	</div><!-- /content -->

	<div data-role="footer" class="ui-bar"  data-position="fixed">
		<a href="#logbook" id="buttonLogAdd"  data-role="button" data-icon="plus" data-transition="slidedown">Finish &amp; Save</a>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of login page -->
<div data-role="page" id="settings">

	<div data-role="header">
		<h1>Settings</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<p>Settings Form Goes Here</p>	
		<p>View internal page called <a href="#logbook" data-transition="flip">logbook</a></p>		
		
		<a href="#logout" data-role="button">Sign Out</a>
	
	</div><!-- /content -->

	<div data-role="footer"  class="ui-bar" data-position="fixed">
		<a href="#logbook" data-role="button" data-icon="plus" data-transition="flip">Save</a>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of login page -->
<div data-role="page" id="logout">

	
	<div data-role="content">	
		<h1>Bye bye!</h1>
	</div><!-- /content -->

	
</div><!-- /page -->
<script type="text/javascript" src="sha1.js"></script>
<script type="text/javascript">
$.support.cors = true;
var apikey = "XZ8f7a50d6UrXegrqAXlNMhHD91O81z2";

	$( document ).bind( "mobileinit", function() {
	    $.mobile.allowCrossDomainPages = true;

	});
	$(document).delegate("#splash","pageinit",function() {
		console.log("Splash loaded");
		logged_in = localStorage.getItem("logged_in");
		
		if(logged_in == "true") {
			$.mobile.changePage( "#logbook");
		}

	});
	$( document ).delegate("#login", "pageinit", function() {



	 	$("#loginForm").submit(function() {
	 		event.preventDefault();
	 		$.post("http://beta.irow.co.uk/apilogin/?api_key="+apikey, 
	 			{ email: $("#loginEmail").val(), password: $("#loginPassword").val() })
	 			.done( function(data) {
	 			//alert('Yey,we broke in the keys are ' + data.k1 + ' and ' + data.k2);
	 			console.log("user is now logged in!");
	        	localStorage.setItem("token_private", data.k2);
	      		localStorage.setItem("token_public", data.k1);
	      		localStorage.setItem("logged_in",true);
	      		$.mobile.changePage( "#logbook");
	 		}).error(function(jqXHR, textStatus, errorThrown) {
	 			alert('You couldn\'t be logged in');
	 			
	 		});
	 	});
	});

	function getAuthorizedUrl(plainUrl) {
		var timestamp = Math.round(+new Date()/1000);
		newUrl = plainUrl + "?api_key="+apikey+"&key="+localStorage.getItem("token_public")+"&timestamp="+timestamp+"&hash="+Sha1.hash(timestamp+localStorage.getItem("token_private"));
		return newUrl;
	}

	$( document ).delegate("#add", "pagebeforecreate", function() {
		if(localStorage.getItem("exercise_types")) {
			types = $.parseJSON(localStorage.getItem("exercise_types"));
			$.each(types,function(key,obj) {
				$.each(obj,function(key2,obj2){
					$("#inputType").append('<option value="'+obj2.value+'">'+key+' - '+obj2.label+'</option>');
				});
			});
			    var today = new Date();
			    var dd = today.getDate();
			    var mm = today.getMonth()+1; //January is 0!

			    var yyyy = today.getFullYear();
			    if(dd<10){dd='0'+dd} if(mm<10){mm='0'+mm} var today = yyyy+'-'+mm+'-'+dd;
			    //document.getElementById("DATE").value = today;
			    
			$("#inputWhen").val(today);
		}
	});

	$( document ).delegate("#logbook", "pageinit", function() {
		
		
		if(sync()) {

		}	else {
			displayLogbook();
		}
		if(localStorage.getItem("logbookp1") == "") {
			console.log("No logbook data found");
		}
		
		
	});

	$( "#btnSync" ).bind( "tap", function() {
		sync();
	});

	$("#buttonLogAdd").bind("tap",function() {
		addUrl = (getAuthorizedUrl("http://beta.irow.co.uk/api/logbook_add/"));
		data = {
			inputType: $("#inputType").val(),
			inputDistance: $("#inputDistance").val(),
			inputTime: $("#inputTime1").val() + ":" + $("#inputTime2").val(),
			inputSplit: $("#inputSplit1").val() + ":" + $("#inputSplit2").val(),
			inputRate: $("#inputRate").val(),
			inputDate: $("#inputDate").val()
		};
		
		$.ajax({
			url: addUrl,
			dataType: 'json',
			type: 'POST',
			data: data,
			success: function(data) {
				console.log("Deets saved");
				$.mobile.changePage( "#logbook");
			},
			error: function() {
				console.log("Error during log");
			}
		})
	});

	function sync_json_to_ls(url,lsname) {
			$.ajax({
				url: url,
	            dataType: 'text',
	            async: false,
				success: function(data) {
					localStorage.setItem(lsname,data);
					
					console.log("Sync of "+url+" successful");
					//
					
					return true;
				},
				error: function() {
					console.log("Error during sync of " + url);
					return false;
				}
			});
		}

	function sync() {
		var status = true;
		console.log("Syncing data");
		$.mobile.loading('show');
		logbookUrl = (getAuthorizedUrl("http://beta.irow.co.uk/api/logbook_feed/"));
		status = status && sync_json_to_ls(logbookUrl,"logbookp1");
		if(status == true) {
			displayLogbook();
		} else {
			//$("#syncError").show();
		}
		etypesUrl = getAuthorizedUrl("http://beta.irow.co.uk/api/exercise_types/");
		status = status && sync_json_to_ls(etypesUrl,"exercise_types");

		$.mobile.loading('hide');
		
		return status;
		
	}

	function displayLogbook() {
		$('#logbookList').html('');
		var logbookData = $.parseJSON(localStorage.getItem("logbookp1"));
		var lastDate = null;
				var dividerCounter = 1;
				$.each(logbookData,function(key,object) {
					var li = '';
					if(object.date != lastDate) {
						$('span.ul-li-count').text(dividerCounter);
						dividerCounter = 1;
					 li 	+= '<li data-role="list-divider">'+object.date
					+ '<!--<span class="ui-li-count"></span>--></li>' ;
					lastDate = object.date;
					} else {
						dividerCounter += 1;
					}
					
					li += '<li><a href="#activity" data-transition="slide">'				
		+'					<h3>'+object.label+'</h3>'
		+ '					<p><strong>'+object.split+'</strong></p>'
		+ '					<p></p>'
		+ '					<p class="ui-li-aside"><strong></strong></p>'				
		+	'		</a></li>';
						jqLi = $(li);
						

						$("#logbookList").append(jqLi);
						jqLi.delegate("a", "tap", function() {
							$("#activity #viewLabel").text(object.label);
							$("#activity #viewSplit").text(object.split);
							$("#activity #viewDistance").text(object.distance);
							$("#activity #viewTime").text(object.time);
							$("#activity #viewRate").text(object.rate);
						});
						
				});
					$( "#logbookList" ).listview( "refresh" );
	}

	$( document ).delegate("#logout", "pagebeforecreate", function() {
			localStorage.setItem("token_private",null);
			localStorage.setItem("token_public",null);
			localStorage.setItem("logged_in",false);
		$.mobile.changePage( "#splash");
		
	});
</script>
</body>
</html>